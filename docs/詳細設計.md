# 課題シート（コード非掲載版）

このドキュメントは、

**「詳細設計を読んでその通りに実装できる」**

力を示すための、

**自力実装用の課題仕様**です。

---

## 0. 目的と進め方

- 目的：
  - 詳細設計（I/F と制約）を尊重し、
    **勝手に仕様を変えずに**
    実装・テストまで完了させる力を示す。
- 進め方：

  1. 本シートの **I/F と制約** を厳守。
  2. まず **インメモリ実装**（DB なし）で API を成立。
  3. 主要テストを自作し、

     正常系・異常系を通す。

  4. 時間と余力に応じて、

     **SQLite + SQLAlchemy** へ拡張（任意）。

- 成果物：
  - 実装一式（FastAPI 想定）
  - テストコード（pytest）
  - README（起動方法・テスト方法・決めたこと）

---

## 1. 用語・データモデル（簡易 ER）

- Customer（顧客）
  - `custId`（ID 文字列）
  - `name`（氏名）
  - `email`（メール・**ユニーク**）
- Product（商品）
  - `prodId`（ID 文字列）
  - `name`（商品名）
  - `unitPrice`（単価・**1 以上**）
- Order（注文）
  - `orderId`（ID 文字列）
  - `custId`（顧客 ID）
  - `orderDate`（日付）
  - `totalAmount`（合計金額）
- OrderItem（注文明細）
  - `orderId`（親の注文 ID）
  - `lineNo`（行番号・1 始まり）
  - `prodId`（商品 ID）
  - `qty`（数量・**1 以上**）
  - `unitPrice`（明細単価）
  - `lineAmount`（明細金額 = unitPrice × qty）
- 計算ルール：
  - `lineAmount = unitPrice * qty`
  - `totalAmount = Σ(lineAmount)`

---

## 2. ユースケース

- UC-1：顧客を登録する。
- UC-2：商品を登録する。
- UC-3：注文を登録する（存在する顧客・商品に限る）。
- UC-4：顧客の注文履歴を検索する（期間・ページング付き）。

---

## 3. API I/F（**固定・厳守**）

### 3.1 顧客登録

- `POST /customers`
- Request（JSON）
  ```json
  { "name": "Alice", "email": "a@example.com" }
  ```
- Response（JSON）
  ```json
  { "custId": "C_xxxx", "name": "Alice", "email": "a@example.com" }
  ```

### 3.2 商品登録

- `POST /products`
- Request（JSON）
  ```json
  { "name": "Pen", "unitPrice": 100 }
  ```
- Response（JSON）
  ```json
  { "prodId": "P_xxxx", "name": "Pen", "unitPrice": 100 }
  ```

### 3.3 注文登録

- `POST /orders`
- Request（JSON）
  ```json
  {
    "custId": "C_xxxx",
    "items": [{ "prodId": "P_xxxx", "qty": 2 }]
  }
  ```
- Response（JSON）
  ```json
  {
    "orderId": "O_xxxx",
    "orderDate": "YYYY-MM-DD",
    "totalAmount": 200,
    "items": [
      {
        "lineNo": 1,
        "prodId": "P_xxxx",
        "qty": 2,
        "unitPrice": 100,
        "lineAmount": 200
      }
    ]
  }
  ```

### 3.4 注文検索

- `GET /orders?custId=...&from=YYYY-MM-DD&to=YYYY-MM-DD&page=0&size=20`
- Response（JSON）
  ```json
  {
    "list": [
      { "orderId": "O_xxxx", "orderDate": "YYYY-MM-DD", "totalAmount": 200 }
    ],
    "totalCount": 1,
    "page": 0,
    "size": 20
  }
  ```
- 備考：
  - 並び順は `orderDate` **降順** とする。

---

## 4. 制約・非機能・I/F ルール

- **I/F の項目名・構造は変更不可。**
- email は **ユニーク**。
- `unitPrice >= 1`、`qty >= 1`。
- 検索範囲：`from <= to`。
- ページング：`page`（0 始まり）、`size`（上限 **100**）。
- エラーレスポンスは JSON で返すこと（形式は自由だが、**原因が分かる message** を含める）。
- 性能目標：p95 200ms 以内（インメモリ実装で可）。

---

## 5. エラー仕様（HTTP）

- `400 Bad Request`：入力バリデーション不正、期間不正、空配列など。
- `404 Not Found`：`custId` または `prodId` が存在しない。
- `409 Conflict`：email 重複。

※ エラー JSON 例（例）：

```json
{ "code": "EMAIL_DUP", "message": "email already exists: a@example.com" }
```

※ `code` 名は任意だが、**一貫性**を保つこと。

---

## 6. 実装要件（層の責務）

- Controller：
  - 入出力（DTO）変換、入力バリデーション、HTTP ステータス整形。
- Service（ユースケース）：
  - 顧客・商品存在チェック、計算、トランザクション境界（DB 化時）。
- Repository/Storage：
  - データアクセスの抽象化（まずはインメモリ）。
- 共通：
  - 例外 →HTTP 変換を一元化（ハンドラ）。

---

## 7. テスト観点（最低限）

- 顧客登録：
  - 正常（201/200 どちらでも可）
  - email 重複 → 409
- 商品登録：
  - 正常
  - `unitPrice=0` → 400
- 注文登録：
  - 正常（合計金額・lineAmount 計算が正しい）
  - 不在顧客 → 404
  - 不在商品 → 404
  - `qty=0` → 400
  - `items=[]` → 400
- 注文検索：
  - 正常（件数・ページング・降順）
  - `from>to` → 400
  - `size>100` → `size=100` として扱う or 400（※どちらかに**統一**）

---

## 8. 受け入れ基準（DoD）

- API I/F を**変更していない**。
- 正常系・異常系テストが **すべて緑**。
- 主要ロジックのユニットテストがある。
- README に：
  - 起動方法（uvicorn など）
  - テスト方法（pytest）
  - 自分が判断して決めた仕様のメモ（例：`size>100` の扱い）
    が記載されている。

---

## 9. 伸び課題（任意・加点）

- DB 化：SQLite + SQLAlchemy（スキーマ、FK、ユニーク制約）。
- 認可：`X-API-KEY` を全 API で要求（テスト含む）。
- OpenAPI ドキュメントの説明追記（例・制約・エラー例）。
- Dockerfile / docker-compose 化。
- ログの相関 ID（リクエストごとに traceId）。

---

## 10. 提出物テンプレ（README 例）

- プロジェクト概要（1〜3 行）
- 実行手順
  - インストール：`pip install -r requirements.txt`
  - 起動：`uvicorn app.main:app --reload`
- テスト：`pytest -q`
- 設計遵守のポイント
  - I/F を変えない
  - 例外 →HTTP を一元化
  - ページングと降順の徹底
- 自分で決めたこと
  - `size>100` の扱い
  - ID 採番方針（UUID など）

---

## 11. 評価チェックリスト（自己採点用）

- [ ] I/F 固定（項目名・構造・型）
- [ ] 400/404/409 の適切な返却
- [ ] 合計金額・明細金額の整合
- [ ] 降順・ページングの正しさ
- [ ] テストが正常系・異常系ともに網羅
- [ ] README が明快で再現性がある

---

## 12. 追加設計書

- [X-API-KEY の認可仕様追補](X-API-KEY.md)

- [pytest テスト観点](pytest.md)

- [DB スキーマ定義](DBスキーマ.md)

※ この課題シートのみを見て、

自力で実装に着手してください。

答え合わせ用の参考実装は、

**別ドキュメント（キャンバス）** に保存済みです。
